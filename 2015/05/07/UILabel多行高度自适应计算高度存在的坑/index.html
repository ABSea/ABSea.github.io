<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ABSea"><title>UILabel多行自适应计算高度存在的坑 | ABSea</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">UILabel多行自适应计算高度存在的坑</h1><a id="logo" href="/.">ABSea</a><p class="description">Practice makes perfect</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/history/"><i class="icon-history"> 历史</i></a><a href="/guestbook/"><i class="icon-guestbook"> 留言</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">UILabel多行自适应计算高度存在的坑</h1><div class="post-meta">2015-05-07<span class="categories"> | 分类于<a href="/categories/IOS/"> IOS</a></span></div><span data-disqus-identifier="2015/05/07/UILabel多行高度自适应计算高度存在的坑/" class="disqus-comment-count"></span><div class="post-content"><p>本文来说明[UILabel][6]在实现多行文本时，计算文本的高度存在的一个问题，因为这个问题之前遇到过很多次，特在测mark一下，给自己留个痕迹，以免后面再碰到，涉及到讨论的两种方法（这两种方法都存在这样的问题）：</p>
<ul>
<li><p><strong>NSMutableAttributedString  的 <em>addAttributes</em> 方法</strong></p>
</li>
<li><p><strong><em>boundingRectWithSize</em></strong></p>
</li>
</ul>
<hr>
<h2 id="u95EE_u9898_u5C55_u793A_uFF1A"><a href="#u95EE_u9898_u5C55_u793A_uFF1A" class="headerlink" title="问题展示："></a>问题展示：</h2><p>先看下图片，展示下问题（测试条件）：</p>
<ul>
<li><strong>具有图片</strong></li>
<li><strong>单行的文字</strong></li>
<li><strong>目前在模拟器上出现的问题，真机尚未测试</strong></li>
</ul>
<p>可以看出“第三个格子的文本覆盖了右上角的时间文字”，但是第四行的文字却没有，两个cell的通过肉眼就能发现是一样的高度，那么问题是什么呢。<br><img src="http://img.blog.csdn.net/20160114223813373" alt="这里写图片描述"></p>
<h2 id="u95EE_u9898_u5206_u6790_uFF1A"><a href="#u95EE_u9898_u5206_u6790_uFF1A" class="headerlink" title="问题分析："></a>问题分析：</h2><p>####下面说明下两种出现这种问题的方法：</p>
<p><strong>第一种计算高度方法</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#10;----------&#10;&#20027;&#35201;&#20195;&#30721;&#10;------&#10;&#10;//NSStringDrawingUsesFontLeading &#20197;&#23383;&#20307;&#38388;&#34892;&#36317;&#20301;&#35745;&#31639;&#26041;&#24335;&#65288;&#23383;&#20307;&#39640;&#24230; + &#34892;&#38388;&#36317;&#65289;&#10;//NSStringDrawingUsesLineFragmentOrigin &#20197;&#27599;&#34892;&#32452;&#25104;&#30340;&#30697;&#24418;&#35745;&#31639;&#39640;&#24230;&#10;&#10; - NSStringDrawingOptions Option =NSStringDrawingUsesLineFragmentOrigin&#10;   | NSStringDrawingUsesFontLeading;&#10;   &#10;   NSMutableParagraphStyle *style = [[NSMutableParagraphStyle alloc]&#10;   init]; [style setLineBreakMode:NSLineBreakByWordWrapping];&#10;&#10;    &#10;NSDictionary *attributes = @&#123; NSFontAttributeName : ChatContentFont, NSParagraphStyleAttributeName : style &#125;;&#10;&#10;contentSize = [strContent boundingRectWithSize:CGSizeMake(textContentWidth, CGFLOAT_MAX) options:Option attributes: attributes context:nil].size;&#10;&#10;&#26368;&#21518;&#65306;&#10;labelHeight = contentSize.height;</span><br></pre></td></tr></table></figure>
<p><strong>第二种计算高度方法</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#10;----------&#10;&#20027;&#35201;&#20195;&#30721;&#10;------&#10;&#10;//NSStringDrawingUsesFontLeading &#20197;&#23383;&#20307;&#38388;&#34892;&#36317;&#20301;&#35745;&#31639;&#26041;&#24335;&#65288;&#23383;&#20307;&#39640;&#24230; + &#34892;&#38388;&#36317;&#65289;&#10;//NSStringDrawingUsesLineFragmentOrigin &#20197;&#27599;&#34892;&#32452;&#25104;&#30340;&#30697;&#24418;&#35745;&#31639;&#39640;&#24230;&#10;&#10; - NSStringDrawingOptions Option =NSStringDrawingUsesLineFragmentOrigin&#10;   | NSStringDrawingUsesFontLeading;&#10;   &#10;NSMutableParagraphStyle *style = [[NSMutableParagraphStyle alloc]&#10;   init]; [style setLineBreakMode:NSLineBreakByWordWrapping];&#10;&#10;UILabel *labelStr = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, textContentWidth, CGFLOAT_MAX)];&#10;//&#35774;&#32622;numberOfLine = 0 ,&#34920;&#31034;&#22810;&#34892;&#26174;&#31034;&#10;labelStr.numberOfLines = 0;&#10;            &#10;NSMutableAttributedString *attrStr = [[NSMutableAttributedString alloc] initWithString:_message.strContent];&#10;            &#10;CGFloat actualTextLen = textContentWidth;&#10;if (attrStr.length &#60; textContentWidth) &#123;          &#10;&#9;actualTextLen = attrStr.length;&#10;&#125;&#10;&#10;//range &#21442;&#25968;&#34920;&#31034;&#20174;&#23383;&#31526;&#20018;&#30340;0&#20301;&#32622;&#24320;&#22987;&#30340;actualTextLen&#20010;&#23383;&#31526;&#10;//&#20026;&#36825;&#20010;&#33539;&#22260;&#20869;&#30340;&#23383;&#31526;&#28155;&#21152;&#23545;&#24212;&#30340;&#23646;&#24615;&#10;[attrStr addAttributes:attributes range:NSMakeRange(0, actualTextLen)];&#10;labelStr.attributedText = attrStr;&#10;[labelStr sizeToFit];&#10;&#10;&#26368;&#21518;&#65306;&#10;labelHeight = labelStr.frame.size.height&#65307;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="23_23_23_23_u8FD9_u4E24_u79CD_u65B9_u6CD5_u90FD_u4F1A_u9020_u6210_u4E0A_u9762_u56FE_u7247_u6240_u63CF_u8FF0_u7684_u95EE_u9898_uFF1A_u5176_u6253_u5370_u51FA_u6765_u7684_u9AD8_u5EA6_u89C1_u4E0B_u56FE_uFF1A"><a href="#23_23_23_23_u8FD9_u4E24_u79CD_u65B9_u6CD5_u90FD_u4F1A_u9020_u6210_u4E0A_u9762_u56FE_u7247_u6240_u63CF_u8FF0_u7684_u95EE_u9898_uFF1A_u5176_u6253_u5370_u51FA_u6765_u7684_u9AD8_u5EA6_u89C1_u4E0B_u56FE_uFF1A" class="headerlink" title="####这两种方法都会造成上面图片所描述的问题：其打印出来的高度见下图："></a>####这两种方法都会造成上面图片所描述的问题：其打印出来的高度见下图：</h2><p><img src="http://img.blog.csdn.net/20160115074931409" alt="注意看第五行"></p>
<p>上面的结果打印出来的值解释（以第五行为例）：<br>17.000000          —     16.707031 对应<br>第二种计算方法 — 第一种计算方法</p>
<h2 id="u5206_u6790_u7ED3_u679C_uFF1A"><a href="#u5206_u6790_u7ED3_u679C_uFF1A" class="headerlink" title="分析结果："></a>分析结果：</h2><ol>
<li>经过测试下，这种情况只有在文字的长度小于一行时才会出现</li>
<li>当刚满一行时就计算成33了，如第一张图的第三个cell显示的那样</li>
<li>而且在简单测试时候发现只有存在图片时候会出现这样的问题</li>
</ol>
<hr>
<p> <strong><em>结论</em></strong>就是：在单行不满的情况下，如果“文字Label”具有背景色的时候，就会出现布局上面的问题，在table滑动的时候会出现“文字Label”背景色加高从而覆盖右上角的“时间”Label的问题。</p>
<hr>
<h2 id="u89E3_u51B3_u529E_u6CD5_uFF1A"><a href="#u89E3_u51B3_u529E_u6CD5_uFF1A" class="headerlink" title="解决办法："></a>解决办法：</h2><hr>
<p>因为这样会影响用户的体验效果，所以参照log打印出来的值，第四行和第五行，同样是显示一行，一个高度是33，一个高度是17。所以问题最简单的处理方法就是在17 的基础上加上18，也就是判断高度的值，如果小于33，就加上18，如果没有就以计算的原值为最终计算的高度值， <strong>17 + 18 = 35</strong>，多了两个高度点（这个值可以自己上下调节两三个高度点）<br>，然后最终的效果出来，如下图：<br><img src="http://img.blog.csdn.net/20160115080626721" alt="这里写图片描述"></p>
<hr>
<p>经简单测试，这样修改后，在随意的滑动table时候，“文字Label”的背景色不会出现上述的问题；</p>
<p>因时间关系，目前只探索到这里，后续有更好的令人信服的方法时，再更新，也欢迎有大神提出更好的方案。</p>
<hr>
</div><div class="tags"><a href="/tags/IOS/">IOS</a><a href="/tags/UILabel/">UILabel</a><a href="/tags/高度计算/">高度计算</a></div><div class="post-nav"><a href="/2015/11/07/mac安装nodejs/" class="pre"><i class="icon-previous">Mac安装nodejs</i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'absea';
var disqus_identifier = '2015/05/07/UILabel多行高度自适应计算高度存在的坑/';
var disqus_title = 'UILabel多行自适应计算高度存在的坑';
var disqus_url = 'http://yoursite.com/2015/05/07/UILabel多行高度自适应计算高度存在的坑/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//absea.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/IOS/">IOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/NodeJS/">NodeJS</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/IOS/" style="font-size: 15px;">IOS</a> <a href="/tags/UILabel/" style="font-size: 15px;">UILabel</a> <a href="/tags/高度计算/" style="font-size: 15px;">高度计算</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/NodeJS/" style="font-size: 15px;">NodeJS</a> <a href="/tags/安装/" style="font-size: 15px;">安装</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015/11/07/mac安装nodejs/">Mac安装nodejs</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/05/07/UILabel多行高度自适应计算高度存在的坑/">UILabel多行自适应计算高度存在的坑</a></li></ul></div><div class="widget"><div class="widget-title">最近评论</div><script type="text/javascript" src="//absea.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://blog.csdn.net/u010053344" title="CSDN" target="_blank">CSDN</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">ABSea.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>